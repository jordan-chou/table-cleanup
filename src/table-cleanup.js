/* DEFAULT VALUES */
let attributesDefault =
`
width
valign
align
border
cellspacing
cellpadding
nowrap
`

let tagsDefault =
`
p
`

let inputDefault =
`
<table border="0" cellspacing="0" cellpadding="0" width="99%">
  <tr>
    <td width="208" valign="bottom"><p>&nbsp;</p></td>
    <td width="71" valign="bottom"><p>2018– <br>
      2019&nbsp;&nbsp;</p></td>
    <td width="71" valign="bottom"><p>2019–<br>
      2020&nbsp;&nbsp;</p></td>
    <td width="71" valign="bottom"><p>2020–<br>
      2021&nbsp;&nbsp;</p></td>
    <td width="71" valign="bottom"><p>2021–<br>
      2022&nbsp;&nbsp;</p></td>
    <td width="71" valign="bottom"><p>2022–<br>
      2023&nbsp;&nbsp;</p></td>
    <td width="71" valign="bottom"><p>2023–<br>
      2024&nbsp;&nbsp;</p></td>
    <td width="71" valign="bottom"><p>Total</p></td>
  </tr>
  <tr>
    <td width="208" valign="bottom"><p>Section Heading </p></td>
    <td width="71" nowrap valign="bottom"><p align="right"><strong>0 </strong></p></td>
    <td width="71" nowrap valign="bottom"><p align="right"><strong>9 </strong></p></td>
    <td width="71" nowrap valign="bottom"><p align="right"><strong>10 </strong></p></td>
    <td width="71" nowrap valign="bottom"><p align="right"><strong>10 </strong></p></td>
    <td width="71" nowrap valign="bottom"><p align="right"><strong>10 </strong></p></td>
    <td width="71" nowrap valign="bottom"><p align="right"><strong>10 </strong></p></td>
    <td width="71" nowrap valign="bottom"><p align="right"><strong>50 </strong></p></td>
  </tr>
  <tr>
    <td width="208" valign="bottom"><p>Row Heading </p></td>
    <td width="71" nowrap valign="bottom"><p align="right">0</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">0</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">0</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">0</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">0</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">0</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">0</p></td>
  </tr>
  <tr>
    <td width="208" valign="bottom"><p>Row Heading</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">0</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">9</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">50</p></td>
  </tr>
  <tr>
    <td width="208" valign="bottom"><p>&nbsp;&nbsp;Sub heading level 1</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">0</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">9</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">50</p></td>
  </tr>
  <tr>
    <td width="208" valign="bottom"><p>&nbsp;&nbsp;Sub heading level 1</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">0</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">9</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">50</p></td>
  </tr>
  <tr>
    <td width="208" valign="bottom"><p>Section Heading</p></td>
    <td width="71" nowrap valign="bottom"><p align="right"><strong>0 </strong></p></td>
    <td width="71" nowrap valign="bottom"><p align="right"><strong>9 </strong></p></td>
    <td width="71" nowrap valign="bottom"><p align="right"><strong>10 </strong></p></td>
    <td width="71" nowrap valign="bottom"><p align="right"><strong>10 </strong></p></td>
    <td width="71" nowrap valign="bottom"><p align="right"><strong>10 </strong></p></td>
    <td width="71" nowrap valign="bottom"><p align="right"><strong>10 </strong></p></td>
    <td width="71" nowrap valign="bottom"><p align="right"><strong>50 </strong></p></td>
  </tr>
  <tr>
    <td width="208" valign="bottom"><p>Row Heading </p></td>
    <td width="71" nowrap valign="bottom"><p align="right">0</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">0</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">0</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">0</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">0</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">0</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">0</p></td>
  </tr>
  <tr>
    <td width="208" valign="bottom"><p>&nbsp;&nbsp;Sub heading level 1</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">0</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">9</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">50</p></td>
  </tr>
  <tr>
    <td width="208" valign="bottom"><p>&nbsp;&nbsp;Sub heading level 1</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">0</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">9</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">50</p></td>
  </tr>
  <tr>
    <td width="208" valign="bottom"><p>&nbsp;&nbsp;&nbsp;&nbsp;Sub heading level 2</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">0</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">9</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">50</p></td>
  </tr>
  <tr>
    <td width="208" valign="bottom"><p>&nbsp;&nbsp;&nbsp;&nbsp;Sub heading level 2</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">0</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">9</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">50</p></td>
  </tr>
  <tr>
    <td width="208" valign="bottom"><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sub heading level 3</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">0</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">9</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">50</p></td>
  </tr>
  <tr>
    <td width="208" valign="bottom"><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sub heading level 3</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">0</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">9</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">50</p></td>
  </tr>
  <tr>
    <td width="208" valign="bottom"><p>Row Heading</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">0</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">9</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">50</p></td>
  </tr>
  <tr>
    <td width="208" valign="bottom"><p>Row Heading</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">0</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">9</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">10</p></td>
    <td width="71" nowrap valign="bottom"><p align="right">50</p></td>
  </tr>
</table>
`

const inputHTML = document.createElement('div');
var xStartPos, xEndPos;
var yStartPos, yEndPos;
var toggledCells = 0;
var isMouseDown = false;

/**
 * Performs script after the window has loaded
 */
window.onload = function () {
    /**
     * Create event listeners for script trigger and user interaction
     */
     function createListeners() {
        const cleanupBtn = document.getElementById('cleanupBtn');
        const results = document.getElementById('results');
        const outputText = document.getElementById('outputText');
        const copyBtn = document.getElementById('copyBtn');
        const copyBtn2 = document.getElementById('copyBtn2');
        const visual = document.getElementById('visual');

        const deselectBtn = document.getElementById('deselectBtn');
        const theadBtn = document.getElementById('theadBtn')
        const mergeRowBtn = document.getElementById('mergeRowBtn');
        const activeBtn = document.getElementById('activeBtn');
        const mergeBtn = document.getElementById('mergeBtn');
        const tfootBtn = document.getElementById('tfootBtn');
        const indentBtn = document.getElementById('indentBtn');
        const outdentBtn = document.getElementById('outdentBtn');
        const boldBtn = document.getElementById('boldBtn');
        const leftAlignBtn = document.getElementById('leftAlignBtn');
        const centerAlignBtn = document.getElementById('centerAlignBtn');
        const rightAlignBtn = document.getElementById('rightAlignBtn');
        const deleteRowBtn = document.getElementById('deleteRowBtn')

        const tableToolbar = document.getElementById('tableToolbar');

        cleanupBtn.addEventListener('click', () => {
            const moveToTfootChecked = document.getElementById('moveToTfoot').checked; 
            parseInput();
            cleanInput();

            if (moveToTfootChecked) {
                let tbody = visual.querySelector('tbody');
                let row = tbody.querySelector('tr:last-child');
                row.querySelector('th, td').classList.add('selected');
                moveToTfoot();
            }

            // Add selection listeners to all table cells
            let cells = visual.querySelectorAll('th, td:not(tfoot td)');
            cells.forEach(e => {
                // e.addEventListener('click', () => {
                //     e.classList.toggle('selected');
                //     tableToolbar.classList.toggle('wb-inv', visual.querySelectorAll('.selected').length == 0);
                // })
                var xCellPos, yCellPos;


                const allRows = visual.querySelectorAll('tr');

                for (var y = 0; y < allRows.length; y++) {
                    const allCellsInRow = allRows[y].querySelectorAll('th, td');
                    for (var x = 0; x < allCellsInRow.length; x++) {
                        if (allCellsInRow[x] == e) {
                            xCellPos = x;
                            yCellPos = y;
                        }
                    }
                }

                e.addEventListener('mousedown', () => {
                    toggledCells = 0;
                    for (var y = 0; y < allRows.length; y++) {
                        const allCellsInRow = allRows[y].querySelectorAll('th, td');
                        for (var x = 0; x < allCellsInRow.length; x++) {
                            if (allCellsInRow[x] == e) {
                                xStartPos = x;
                                yStartPos = y;
                                isMouseDown = true;
                                // e.classList.toggle('selected');
                                // tableToolbar.classList.toggle('wb-inv', visual.querySelectorAll('.selected').length == 0);
                                break;
                            }
                        }
                    }
                    // console.log(`${xStartPos}, ${yStartPos}`);
                });

                e.addEventListener('mouseenter', () => {
                    if (!isMouseDown) return;
                    
                    for (var y = 0; y < allRows.length; y++) {
                        const allCellsInRow = allRows[y].querySelectorAll('th, td');
                        for (var x = 0; x < allCellsInRow.length; x++) {
                            if (allCellsInRow[x] == e) {
                                xEndPos = x;
                                yEndPos = y;
                                break;
                            }
                        }
                    }

                    xMin = Math.min(xStartPos, xEndPos);
                    xMax = Math.max(xStartPos, xEndPos);
                    yMin = Math.min(yStartPos, yEndPos);
                    yMax = Math.max(yStartPos, yEndPos);

                    for (var y = 0; y < allRows.length; y++) {
                        const allCellsInRow = allRows[y].querySelectorAll('th, td');
                        skipColSpan = 0;
                        for (var x = 0; x < allCellsInRow.length; x++) {
                            if (x >= xMin && x <= xMax - skipColSpan && y >= yMin && y <= yMax) {
                                if (!allCellsInRow[x]) break;

                                if (!allCellsInRow[x].classList.contains('selected')) {
                                    allCellsInRow[x].classList.add('hovered');
                                }

                                if (allCellsInRow[x].hasAttribute('colspan')) {
                                    skipColSpan += allCellsInRow[x].getAttribute('colspan') - 1 - x;
                                }
                            } else {
                                allCellsInRow[x].classList.remove('hovered');
                            }
                            
                        }
                    }
                });

                e.addEventListener('mouseup', () => {
                    var xMin, xMax;
                    var yMin, yMax;

                    var skipColSpan = 0;

                    for (var y = 0; y < allRows.length; y++) {
                        const allCellsInRow = allRows[y].querySelectorAll('th, td');
                        for (var x = 0; x < allCellsInRow.length; x++) {
                            if (allCellsInRow[x] == e) {
                                xEndPos = x;
                                yEndPos = y;
                                isMouseDown = false;
                                break;
                            }
                        }
                    }

                    if (xStartPos - xEndPos == 0 && yStartPos - yEndPos == 0 && e.classList.contains('selected')) {
                        e.classList.remove('selected');
                        tableToolbar.classList.toggle('wb-inv', visual.querySelectorAll('.selected').length == 0);
                        return;
                    }

                    xMin = Math.min(xStartPos, xEndPos);
                    xMax = Math.max(xStartPos, xEndPos);
                    yMin = Math.min(yStartPos, yEndPos);
                    yMax = Math.max(yStartPos, yEndPos);
                    
                    for (var y = yMin; y <= yMax; y++) {
                        const allCellsInRow = allRows[y].querySelectorAll('th, td');
                        skipColSpan = 0;
                        for (var x = xMin; x <= xMax - skipColSpan; x++) {
                            if (!allCellsInRow[x]) break;
                            toggledCells++;
                            // console.log(x);
                            allCellsInRow[x].classList.add('selected');
                            allCellsInRow[x].classList.remove('hovered');
                            tableToolbar.classList.toggle('wb-inv', visual.querySelectorAll('.selected').length == 0);
                            if (allCellsInRow[x].hasAttribute('colspan')) {
                                skipColSpan += allCellsInRow[x].getAttribute('colspan') - 1 - x;
                            }
                        }
                    }

                });
            });

            // Show results and scroll to it
            results.classList.remove('wb-inv');
            scrollSmoothTo(visual);
        });

        const tableNumInput = document.getElementById('tableNum');

        tableNumInput.addEventListener('keyup', updateTableID);

        // link 'click' event listers to function
        deselectBtn.addEventListener('click', deselectCells);
        theadBtn.addEventListener('click', toggleThead);
        mergeRowBtn.addEventListener('click', mergeAllCellsInRow);
        activeBtn.addEventListener('click', toggleActiveClass);
        mergeBtn.addEventListener('click', mergeCellsInRow);
        tfootBtn.addEventListener('click', moveToTfoot);
        indentBtn.addEventListener('click', increaseIndent);
        outdentBtn.addEventListener('click', decreaseIndent);
        boldBtn.addEventListener('click', handleBold);
        leftAlignBtn.addEventListener('click', () => handleAlign('left'));
        centerAlignBtn.addEventListener('click', () => handleAlign('center'));
        rightAlignBtn.addEventListener('click', () => handleAlign('right'));
        deleteRowBtn.addEventListener('click', deleteRow);
        copyBtn.addEventListener('click', () => {
            copyToClipboard(outputText);
        });
        copyBtn2.addEventListener('click', () => {
            copyToClipboard(outputText);
        });

        // deselect all if click outside of visual
        document.addEventListener('click', (event) => {
            if (!visual.contains(event.target) && !tableToolbar.contains(event.target)) {
                deselectCells();
            }
        });
    }

    /**
     * 
     */
    function updateTableID() {
        const tableNumInput = document.getElementById('tableNum');
        const tableID = document.getElementById('tableID');

        // create unique ID, based on table num if exists
        let uniqueID = '';
        if (tableNumInput.value) {
            let parts = tableNumInput.value.split(' ');
            for (var s of parts) {
                if (s.match(/^\D/)) {
                    uniqueID += s.charAt(0).toLowerCase();
                }
                else if (s.match(/[^A-Za-z]/)) {
                    if (s.includes('.')) {
                        if (s.endsWith('.')) {
                            s = s.slice(0, s.length-1);
                        }
                        s = s.replaceAll('.', '-');
                    }
                    uniqueID += s;
                }
            }
        }

        tableID.value = uniqueID;
    }

    /**
     * Removes selected class from all elements
     */
     function deselectCells() {
        const visual = document.getElementById('visual');
        const tableToolbar = document.getElementById('tableToolbar');

        let cells = visual.querySelectorAll('th, td');
        for (var cell of cells) {
            cell.classList.remove('hovered');
        }

        let selected = visual.querySelectorAll('.selected');
        for (var cell of selected) {
            cell.classList.remove('selected');
            if (cell.classList.length <= 0) {
                cell.removeAttribute('class');
            }
        }
        
        
        tableToolbar.classList.add('wb-inv');
    }

    /**
     * Checks selected rows and moves to thead or tbody
     */
    function toggleThead() {
        const visual = document.getElementById('visual');
        const tableDiv = visual.querySelector('div.table-responsive');
        const thead = visual.querySelector('thead');
        const tbody = visual.querySelector('tbody');

        let tbodyTRs = tbody.querySelectorAll('tr');
        let theadTRs = thead.querySelectorAll('tr');

        moveTRToThead(tbodyTRs, thead);
        moveTRToTbody(theadTRs, tbody);

        deselectCells();
        var node = copyVisualHTML(tableDiv);
        displayOutput(node);
    }

    

    /**
     * Moves input table rows to the bottom of the table head
     * @param {*} moveTRs NodeList of TR DOM elements
     * @param {*} thead THEAD DOM element receiving the table rows
     */
    function moveTRToThead(moveTRs, thead) {
        const finTableChecked = document.getElementById('finTable').checked;
        // const scopeChecked = document.getElementById('scope').checked;

        for (var moveTR of moveTRs) {
            if (moveTR.querySelector('.selected')) {
                moveTR.classList.add('bg-dark', 'text-white');
                moveTR.classList.remove('active');
        
                var count = 0;

                moveTR.querySelectorAll('th, td').forEach((node) => {
                    // add 'text-right' class to <th> if financial table
                    if (finTableChecked && count > 0 && node.nodeName === 'TD') {
                        node.classList.add('text-right');
                    }
                    var newNode = renameTag(node, 'th');

                    // if (scopeChecked) {
                    //     newNode.setAttribute('scope', 'col');
                    // }

                    count++;
                });
                thead.appendChild(moveTR);
            }
        }
    }

     /**
     * Moves input table rows to the top of the table body
     * @param {*} moveTRs NodeList of TR DOM elements
     * @param {*} tbody TBODY DOM element receiving the table rows
     */
      function moveTRToTbody(moveTRs, tbody) {
        const finTableChecked = document.getElementById('finTable').checked;
        // const scopeChecked = document.getElementById('scope').checked;

        for (var moveTR of moveTRs) {
            if (moveTR.querySelector('.selected')) {
                moveTR.classList.remove('bg-dark', 'text-white');
        
                let ths = moveTR.querySelectorAll('th');
                for (var i = 0; i < ths.length; i++) {
                    // if (i === 0) {
                    //     if (scopeChecked) {
                    //         ths[i].setAttribute('scope', 'row');
                    //     }
                    //     continue;
                    // }
                    var newNode = renameTag(ths[i], 'td');
                    // add 'text-right' class to <td> if financial table
                    if (finTableChecked) {
                        newNode.classList.remove('text-right');
                        var tds = moveTR.querySelectorAll('td');
                        for (var td of tds) {
                            td.classList.add('text-right');
                        }
                    }
                }
                tbody.insertBefore(moveTR, tbody.querySelector('tr'));
            }
        }
    }

    /**
     * Checks selected rows and moves to tfoot
     */
    function moveToTfoot() {
        const visual = document.getElementById('visual');
        const tableDiv = visual.querySelector('div.table-responsive');
        const tbody = visual.querySelector('tbody');
        
        let tbodyTRs = tbody.querySelectorAll('tr');
        
        moveTRToTfoot(tbodyTRs);
        
        const tableToolbar = document.getElementById('tableToolbar'); 
        tableToolbar.classList.toggle('wb-inv', visual.querySelectorAll('.selected').length == 0);

        deselectCells();
        var node = copyVisualHTML(tableDiv);
        displayOutput(node);
    }

    /**
     * Moves selected table rows to a 'p' tag in Tfoot. Creates a tfoot if one doesn't exist
     * @param {*} moveTRs table rows that are selected to be moved
     */
    function moveTRToTfoot(moveTRs) {
        const visual = document.getElementById('visual');
        let tfoot = visual.querySelector('tfoot');
        const table = visual.querySelector('table');

        if (!tfoot) {
            addTfoot(table, false);
            tfoot = table.querySelector('tfoot');
        }
        for (var moveTR of moveTRs) {
            let cell = moveTR.querySelector('.selected');
            if (cell) {
                let tfootTD = tfoot.querySelector('tr > td');
                let p = document.createElement('p');
                
                p.innerHTML = cell.innerHTML;
                tfootTD.appendChild(p);

                moveTR.parentNode.removeChild(moveTR)
            }
        }
    }

    /**
     * Checks selected rows and deletes the row
     */
     function deleteRow() {
        const visual = document.getElementById('visual');
        const tableDiv = visual.querySelector('div.table-responsive');
        const tbody = visual.querySelector('tbody');
        
        let tbodyTRs = tbody.querySelectorAll('tr');
        
        deleteTRs(tbodyTRs);
        
        const tableToolbar = document.getElementById('tableToolbar'); 
        tableToolbar.classList.toggle('wb-inv', visual.querySelectorAll('.selected').length == 0);

        deselectCells();
        var node = copyVisualHTML(tableDiv);
        displayOutput(node);
    }

    /**
     * Deletes selected table rows
     * @param {*} deleteTRs table rows that are selected to be deleted
     */
     function deleteTRs(deleteTRs) {
        for (var tr of deleteTRs) {
            let cell = tr.querySelector('.selected');
            if (cell) {
                tr.parentNode.removeChild(tr)
            }
        }
    }

    /**
     * Gets all selected elements and toggles bold style
     */
    function handleBold() {
        const visual = document.getElementById('visual');
        const tableDiv = visual.querySelector('div.table-responsive');

        let selected = visual.querySelectorAll('.selected');

        var allBold = 1;

        // jordan - "Word-like" bolding method
        for (var cell of selected) {
            if (cell.nodeName == 'TH') {
                if (cell.classList.contains('fnt-nrml')) {
                    allBold = 0;
                    for (var c of selected) {
                        setBold(c, true);
                    }
                    break;
                }
            }

            else if (cell.firstChild.nodeName != 'STRONG' || cell.classList.contains('fnt-nrml')) {
                allBold = 0;
                for (var c of selected) {
                    setBold(c, true);
                }
                break;
            }
        }

        if (allBold) {
            for (var cell of selected) {
                setBold(cell, false);
            }
        }

        var node = copyVisualHTML(tableDiv);
        displayOutput(node);
    }

    /**
     * Sets or remove bold style to cell depending on the value
     * @param {*} cell TD or TH DOM element
     * @param {*} value true or false
     */
    function setBold(cell, value) {
        // value true
        if (value) {
            // th: remove fnt-nrml class
            if (cell.nodeName === 'TH' || cell.nodeName === 'DIV') {
                cell.classList.remove('fnt-nrml');
            }
            // td: check if strong tag doesn't exist
            else if (cell.firstChild.nodeName != 'STRONG') {
                let strong = document.createElement('strong');

                while (cell.firstChild) {
                    strong.appendChild(cell.firstChild);
                }

                cell.appendChild(strong);
            }

        }

        // value false, remove bold
        else {
            // th: add fnt-nrml class
            if (cell.nodeName === 'TH' || cell.nodeName === 'DIV') {
                cell.classList.add('fnt-nrml');
            }
            // td: remove strong tag
            else if (cell.firstChild.nodeName == 'STRONG') {
                removeTag(cell.firstChild, 'strong');
            }
            else if (cell.firstChild.nodeName == 'B') {
                removeTag(cell.firstChild, 'b');
            }
        }
    }

    /**
     * Checks current indent level of selected elements and increases indent accordingly
     */
    function increaseIndent() {
        const visual = document.getElementById('visual');
        const tableDiv = visual.querySelector('div.table-responsive');

        var mrgnLvl = ['mrgn-lft-md', 'mrgn-lft-lg', 'mrgn-lft-xl']

        // use jquery to look for selected element that does not have either of the 3 mrgn classes
        const noMargin    = $("tbody th.selected:not(:has(." + mrgnLvl[0] + ",." + mrgnLvl[1] + ",." + mrgnLvl[2] + "))");
        const subHeading  = visual.querySelectorAll('tbody th.selected div.' + mrgnLvl[0]);
        const sub2Heading = visual.querySelectorAll('tbody th.selected div.' + mrgnLvl[1]);


        // create margin div in these nodes
        for (var node of noMargin) {
            let indent = document.createElement('div');
                indent.classList.add('text-left', 'fnt-nrml', 'mrgn-lft-md');

                // move node's children to new div
                while (node.firstChild) {
                    indent.appendChild(node.firstChild);
                }

                node.appendChild(indent);
        }

        for (var node of subHeading) {
            setIndent(node, mrgnLvl[1], mrgnLvl[0]);
        }

        for (var node of sub2Heading) {
            setIndent(node, mrgnLvl[2], mrgnLvl[1]);
        }

        var node = copyVisualHTML(tableDiv);
        displayOutput(node);
    }

    /**
     * Checks current indent level of selected elements and decreases indent accordingly
     */
    function decreaseIndent() {
        const visual = document.getElementById('visual');
        const tableDiv = visual.querySelector('div.table-responsive');

        var mrgnLvl = ['mrgn-lft-md', 'mrgn-lft-lg', 'mrgn-lft-xl']

        const subHeading  = visual.querySelectorAll('tbody th.selected div.' + mrgnLvl[0]);
        const sub2Heading = visual.querySelectorAll('tbody th.selected div.' + mrgnLvl[1]);
        const sub3Heading = visual.querySelectorAll('tbody th.selected div.' + mrgnLvl[2]);

        for (var node of subHeading) {
            node.classList.remove('mrgn-lft-md', 'text-left', 'fnt-nrml');
            if (node.classList.length <= 0) {
                removeTag(node, 'div');
            }
        }

        for (var node of sub2Heading) {
            setIndent(node, mrgnLvl[0], mrgnLvl[1]);
        }

        for (var node of sub3Heading) {
            setIndent(node, mrgnLvl[1], mrgnLvl[2]);
        }

        var node = copyVisualHTML(tableDiv);
        displayOutput(node);
    }

    /**
     * Sets the node's indent level
     * @param {*} node node that is changing indent level
     * @param {*} newClass new indent level
     * @param {*} oldClass old indent level
     */
    function setIndent(node, newClass, oldClass) {
        if (node && oldClass) {
            node.classList.remove(oldClass);
        }
        if (node && newClass) {
            node.classList.add(newClass);
        }
    }

    function mergeAllCellsInRow() {
        const visual = document.getElementById('visual');

        const tbody = visual.querySelector('tbody');
        const rows = tbody.querySelectorAll('tr');

        for (var row of rows) {
            if (row.querySelector('.selected')) {
                const cells = row.querySelectorAll('th, td');

                for (var cell of cells) {
                    cell.classList.add('selected');
                }
                console.log(row);
                mergeCellsInRow();
            }
        }
    }

    /**
     * Checks if a cell in the row is selected and toggles the active class on the row
     */
    function toggleActiveClass() {
        const visual = document.getElementById('visual');
        const tableDiv = visual.querySelector('div.table-responsive');

        let tbody = visual.querySelector('tbody');

        let rows = tbody.querySelectorAll('tr');

        for (var row of rows) {
            if (row.querySelector('.selected')) {
                setAsActive(row);
            }
        }

        var node = copyVisualHTML(tableDiv);
        displayOutput(node);
    }

    /**
     * Toggles 'active' class for <tr> element
     * @param {*} row TR DOM element
     */
    function setAsActive(row) {
        // const scopeChecked = document.getElementById('scope').checked;

        row.classList.toggle('active');

        let cells = row.querySelectorAll('th, td');
        for (var cell of cells) {
            if (cell.nodeName === 'TH') {
                cell.classList.toggle('fnt-nrml', !row.classList.contains('active'));
                // if (scopeChecked) {
                //     if (row.classList.contains('active')) {
                //         cell.setAttribute('scope', 'colgroup');
                //     } else {
                //         cell.setAttribute('scope', 'row');
                //     }
                // }
            }
            else {
                setBold(cell, row.classList.contains('active'));
            }
        }
    }

    /**
     * Checks each row if there is a selected cell, perform merge if more than one is selected
     */
    function mergeCellsInRow() {
        const visual = document.getElementById('visual');
        const tableDiv = visual.querySelector('div.table-responsive');

        let tbody = visual.querySelector('tbody');

        let rows = tbody.querySelectorAll('tr');

        for (var row of rows) {
            let selectedInRow = row.querySelectorAll('.selected');
            if (selectedInRow.length > 1) {
                mergeCells(selectedInRow);
            }
        }

        deselectCells();
        var node = copyVisualHTML(tableDiv);
        displayOutput(node);
    }

    /**
     * Merge cells into one cell
     * Adds colspan with the value of the num of other deleted 'selected' cells
     * @param {*} selected cells with selected class
     */
    function mergeCells(selected) {
        let firstCell = selected[0];
        let count = 1; // start at 1 to include firstCell

        if (firstCell.hasAttribute('colspan')) {
            count = +firstCell.getAttribute('colspan');
        }

        // remove all selected except for first
        for (var i = 1; i < selected.length; i++) {
            if (selected[i].hasAttribute('colspan')) {
                count += +selected[i].getAttribute('colspan');
            } else {
                count += 1;
            }
            firstCell.parentNode.removeChild(selected[i]);
        }

        // set colspan to count (num of deleted cells)
        firstCell.setAttribute('colspan', count);
    }

    /**
     * Removes all other text alignment classes and toggles the text-center class of selected cells
     */
    function handleAlign(alignment) {
        const visual = document.getElementById('visual');
        const tableDiv = visual.querySelector('div.table-responsive');

        let selected = visual.querySelectorAll('.selected');

        for (var cell of selected) {
            if (alignment == 'left') {
                cell.classList.remove('text-right');
                cell.classList.remove('text-center');
            } else if (alignment == 'center') {
                cell.classList.remove('text-right');
                cell.classList.add('text-center');
            } else if (alignment == 'right') {
                cell.classList.add('text-right');
                cell.classList.remove('text-center');
            }
        }

        var node = copyVisualHTML(tableDiv);
        displayOutput(node);
    }

    /**
     * Clones the node while removing .selected classes
     * @param {*} node node to be copied
     * @returns clone node without selected class in all elements
     */
    function copyVisualHTML(node) {
        let clone = node.cloneNode(true);

        clone.querySelectorAll('.selected').forEach((e) => {
            e.classList.remove('selected');
            if (e.classList.length <= 0) {
                e.removeAttribute('class');
            }
        });

        return clone;
    }

    /**
     * Parses input text content into an HTML DOM
     * @returns html dom
     */
    function parseInput() {
        const htmlText = document.getElementById('inputText');

        inputHTML.innerHTML = htmlText.value.trim();
    }

    /**
     * Loop through all elements in the HTML DOM structure and clean it
     * @param {*} html HTML DOM Structure
     */
     function cleanInput() {
        const formatChecked = document.getElementById('format').checked;

        if (inputHTML) {
            inputHTML.querySelectorAll('table').forEach((t) => {
                if (formatChecked) {
                    html = formatTable(t); // 'Format table' option
                }
                cleanElement(t);
                t.querySelectorAll('thead *, tbody *').forEach((e) => {
                    cleanElement(e);
                });
 
                const trimChecked = document.getElementById('trim').checked;
                if (trimChecked) {
                    // trim ths in body
                    let tableDivTHs = t.querySelectorAll('th');
                    for (var th of tableDivTHs) { 
                        if (th.innerText) {
                            if (th.tagName.toLowerCase() === 'th') {
                                th.innerHTML = th.innerHTML.replaceAll(/\s{2,}/g, ' ').trim();
                                th.innerHTML = trimNBSP(th.innerHTML);
                                // th.innerHTML = th.innerHTML.replaceAll('&nbsp;', '').trim();
                            }
                        }                
                    }

                    // trim tds in body
                    let tableDivTDs = t.querySelectorAll('td');
                    for (var td of tableDivTDs) {
                        if (td.innerText) {
                            if (td.tagName.toLowerCase() === 'td') {
                                td.innerHTML = td.innerHTML.replaceAll(/\s{2,}/g, ' ').trim();
                                td.innerHTML = trimNBSP(td.innerHTML);
                            }
                        }    
                    }
                }

                const frNumbersChecked = document.getElementById('frNumbers').checked;
                if (frNumbersChecked) {
                    let tableDivTDs = t.querySelectorAll('td');
                    for (var td of tableDivTDs) {
                        if (td.innerText) {
                            if (td.tagName.toLowerCase() === 'td') {
                                const spaces = /(\d) (\d\d\d)/g;
                                const decimal = /(\d)\.(\d)/g;
                                while (td.innerHTML.match(/\d \d\d\d/)) td.innerHTML = td.innerHTML.replaceAll(spaces, "$1&nbsp;$2");
                                td.innerHTML = td.innerHTML.replaceAll(decimal, "$1,$2");
                            }
                        }    
                    }    
                }
            });

            displayOutput(html);
            displayVisual(html);
        }
    }
        
    /**
     * Removes all &nbsp; from the start and end of the string
     * 
     * @param {string} s input string
     * @returns string with all &nbsp; removed from the start
     */
     function trimNBSP(s) {
        s = s.trim();
        if (s == '&nbsp;') return s;
        while (s.startsWith('&nbsp;')) s = s.substring('&nbsp;'.length);
        while (s.endsWith('&nbsp;')) s = s.substring(0, s.length - '&nbsp;'.length);
        return s;
    }

    /**
     * Adds classes, elements, and attributes to format as WET Style table
     * @param {*} html HTML DOM element
     */
    function formatTable(table) {
        // console.log(table);

        const finTableChecked = document.getElementById('finTable').checked;
        const removeBoldChecked = document.getElementById('removeBold').checked;
        // const scopeChecked = document.getElementById('scope').checked;
        const tfootChecked = document.getElementById('tfoot').checked;
        const tableID = document.getElementById('tableID');
        
        let newlineTab  = document.createTextNode('\n    ');
        table.id = tableID.value;

        // create 'table-responsive' div
        let tableDiv = document.createElement('div');
        tableDiv.classList.add('table-responsive');

        tableDiv.appendChild(table);
        tableDiv.insertBefore(newlineTab.cloneNode(), table);

        let tbody = table.querySelector('tbody');

        if (!table.querySelector('thead')) {
            // Create 'thead' element before tbody
            let thead = document.createElement('thead');
            thead.appendChild(newlineTab);
    
            // get tbody and move 1st tr to thead
            table.insertBefore(thead, tbody);
            table.insertBefore(newlineTab.cloneNode(), tbody);
    
            tbody.querySelector('td').classList.toggle('selected');
            moveTRToThead(tbody.querySelectorAll('tr'), thead);
            thead.querySelector('th').classList.toggle('selected');
        }

        // insert caption
        insertCaption(table);
        
        // add 'table table-bordered' class to table
        table.classList.add('table', 'table-bordered');

        // add 'active' class to tr with colspans
        tbody.querySelectorAll('tr').forEach((tr) => {
            // add 'text-right' class to <th> if financial table
            if (finTableChecked) {
                tr.classList.add('text-right');
            }
            let trFirstChild = tr.querySelector('td, th');
            if (trFirstChild) {
                // rename first child to <th> tag
                var firstChildNode = renameTag(trFirstChild, 'th');
                // if (scopeChecked) {
                //     firstChildNode.setAttribute('scope', 'row');
                // }

                // add 'active' class to <tr> if child has 'colspan'
                if (trFirstChild.hasAttribute('colspan')) {
                    tr.classList.add('active');
                    // if (scopeChecked) {
                    //     trFirstChild.setAttribute('scope', 'colgroup');
                    // }
                }
                // if (scopeChecked && trFirstChild.hasAttribute('rowspan')) {
                //     if (scopeChecked) {
                //         trFirstChild.setAttribute('scope', 'rowgroup');
                //     }
                // }  
                else if (removeBoldChecked) {
                    firstChildNode.classList.add('fnt-nrml');
                }
            }
        });

        // tfoot option checked, create tfoot template
        if (tfootChecked) {
            addTfoot(table, true);
        }

        return tableDiv;
    }

    /**
     * Inserts the caption tag to the top of the tableDiv element
     * @param {*} table HTML TableDiv DOM element 
     * @returns Updated or non-changed TableDiv element
     */
    function insertCaption(table) {
        const tableNumInput = document.getElementById('tableNum');
        const tableTitleInput = document.getElementById('tableTitle');
        const tableUnitInput = document.getElementById('tableUnit');
        
        let caption = document.createElement('caption');
        let linebreak = document.createElement('br');
        let thead = table.querySelector('thead');
        let newlineTab  = document.createTextNode('\n        ');
        let newlineTabSmall  = document.createTextNode('\n    ');

        let tableNum, tableTitle, tableUnit;
        if (tableNumInput.value) {
            tableNum   = document.createTextNode(tableNumInput.value);
        }
        if (tableTitleInput.value) {
            tableTitle = document.createTextNode(tableTitleInput.value);
        }
        if (tableUnitInput.value) {
            tableUnit  = document.createTextNode(tableUnitInput.value);
        }

        let strong = document.createElement('strong');
        let small = document.createElement('small');

        caption.classList.add('text-left', 'fnt-nrml');

        if (tableTitle) {
            strong.appendChild(tableTitle);
        }
        if (tableUnit) {
            small.appendChild(tableUnit);
        }

        caption.appendChild(newlineTab);
        if (tableNum) {
            caption.appendChild(tableNum);
            caption.appendChild(newlineTab.cloneNode());
        }
        if (tableTitle) {
            caption.appendChild(linebreak);
            caption.appendChild(newlineTab.cloneNode());
            caption.appendChild(strong);
            caption.appendChild(newlineTab.cloneNode());
        }
        if (tableUnit) {
            caption.appendChild(linebreak.cloneNode());
            caption.appendChild(newlineTab.cloneNode());
            caption.appendChild(small);
            caption.appendChild(newlineTabSmall);
        }

        if (tableNum || tableTitle || tableUnit) {
            table.insertBefore(caption, thead);
            table.insertBefore(newlineTabSmall.cloneNode(), thead);
        }

        return table;
    }

    /**
     * Adds a tfoot with preset DOM elements according to WET style
     * @param {*} table DOM HTML table
     */
    function addTfoot(table, placeholder) {
        let tfoot = document.createElement('tfoot');
        let tr = document.createElement('tr');
        let td = document.createElement('td');
        var p;
        if (placeholder)
            p = document.createElement('p');

        let newlineTab  = document.createTextNode('\n        ');
        let newlineTabSmall  = document.createTextNode('\n    ');
        let newline  = document.createTextNode('\n');

        // Calculate table width
        let tableWidth = 0;
        let rows = table.querySelectorAll('tr');
        for (var row of rows) {
            tableWidth = Math.max(row.querySelectorAll('th, td').length, tableWidth);
        }

        // set attributes
        tr.classList.add('small');
        td.setAttribute('colspan', tableWidth);

        if (placeholder)
            p.appendChild(document.createTextNode('NOTES, SOURCES and FOOTNOTES GO HERE'));

        // add all to table
        td.appendChild(newlineTab.cloneNode());
        if (placeholder)
            td.appendChild(p);
        td.appendChild(newlineTab.cloneNode());

        tr.appendChild(newlineTab);
        tr.appendChild(td);
        tr.appendChild(newlineTabSmall.cloneNode());

        tfoot.appendChild(newlineTabSmall);
        tfoot.appendChild(tr);
        tfoot.appendChild(newline.cloneNode());

        table.appendChild(newline);
        table.appendChild(tfoot);
        table.appendChild(newline.cloneNode());

        return tfoot;
    }

    /**
     * Replaces a node with a new node of a different tag
     * https://stackoverflow.com/a/15086834
     * @param {*} oldTag tag that will be replaced
     * @param {*} newTag name of new tag that will be created
     */
    function renameTag(oldTag, newTag) {
        let newNode = document.createElement(newTag);

        // Copy the children
        while (oldTag.firstChild) {
            newNode.appendChild(oldTag.firstChild); // *Moves* the child
        }

        // Copy the attributes
        if (oldTag.attributes) {
            for (index = oldTag.attributes.length - 1; index >= 0; --index) {
                newNode.attributes.setNamedItem(oldTag.attributes[index].cloneNode());
            }
        }

        // Replace it
        if (oldTag.parentNode) {
            oldTag.parentNode.replaceChild(newNode, oldTag);
        }

        newNode.addEventListener('click', () => {
            newNode.classList.toggle('selected');
            tableToolbar.classList.toggle('wb-inv', visual.querySelectorAll('.selected').length == 0);
        });

        return newNode;
    }

    /**
     * Removes attributes from DOM element or delete the element if in tag list
     * @param {*} e DOM element
     */
    function cleanElement(e) {


        if (e.hasAttributes()) {
            getAttributeList().forEach(attribute => e.removeAttribute(attribute));
        }

        getTagList().forEach(tag => removeTag(e, tag));
    }
    
    /**
     * Removes DOM if its tag name matches param
     * @param {*} e DOM element
     * @param {*} tag tag name to be removed
     */
    function removeTag(e, tag) {
        if (e.tagName.toLowerCase() === tag.toLowerCase()) {
            const parent = e.parentNode;

            if (parent) {
                // Copy the children
                while (e.firstChild) {
                    parent.appendChild(e.firstChild); // *Moves* the child
                }
                
                // Remove node
                parent.removeChild(e);
            }
        }
    }

    /**
     * Gets an array of attributes from 'Clean Attributes' list, space-separated
     * @returns Array of attribute strings
     */
     function getAttributeList() {
        const attrText = document.getElementById('attrList');
        let attrs = attrText.value.trim().split('\n');
        return attrs;
    }
    
    /**
     * Gets an array of tags from 'Clean Tags' list, space-separated
     * @returns Array of tag strings
     */
    function getTagList() {
        const tagText = document.getElementById('tagList');
        tags = tagText.value.trim().split('\n');

        // check tags
        for (t of tags) {
            if (t.toLowerCase() === 'table') {
                const outputText = document.getElementById('outputText');

                let errorMsg = "Error: Not permitted to remove '" + t + "' tag";
                outputText.textContent = errorMsg;
                throw(errorMsg);
            }
        }
        return tags;
    }

    /**
     * Displays HTML code in Output Results
     * @param {*} html table html
     */
     function displayOutput(html) {
        const output = document.getElementById('outputText');
        output.textContent = html.outerHTML;
    }
    
    /**
     * Displays table HTML as the intended styled output in Visual Results
     * @param {*} html table html
     */
    function displayVisual(html) {
        const visual = document.getElementById('visual');
        visual.innerHTML = html.outerHTML;
    }

    /**
     * Clicking on the input element will copy its contents, present a message
     * and highlight the element.
     * @param {*} outputText DOM element containing the text to copy
     */
     function copyToClipboard(outputText) {
        const copyArea = document.getElementById('copyArea');
        const copiedLabel = document.getElementById('copiedLabel');

        outputText.style.boxShadow = "0px 0px 5px green";
        
        copyArea.textContent = outputText.innerText;

        copyArea.select();
        document.execCommand('copy');

        copiedLabel.classList.remove('wb-inv');
        
        // return to default label after 2000ms
        setTimeout(() => {
            outputText.style.boxShadow = null;
            copiedLabel.classList.add('wb-inv');
        }, 2000);
    }
    
    /**
     * Scrolls window to DOM element
     * @param {*} element DOM element to put into view
     */
    function scrollSmoothTo(element) {
        if (element) {
            element.scrollIntoView({
              block: 'start',
              behavior: 'smooth'
            });
        }
    }

    /*** DEFAULT VALUES START ***/
    const inputText = document.getElementById('inputText');
    inputText.value = inputDefault.trim();

    const attrText = document.getElementById('attrList');
    attrText.value = attributesDefault.trim();

    const tagText = document.getElementById('tagList');
    tagText.value = tagsDefault.trim();
    /*** DEFAULT VALUES END ***/

    createListeners();
}
